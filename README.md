# Система распознавания бухгалтерских документов

Настольное приложение для автоматического распознавания типовых бухгалтерских документов: УПД, ТОРГ-12 и Счёт-фактура. Извлекает реквизиты и табличные данные, формирует структурированный JSON.

## Возможности

- **Определение типа документа** — автоматическая классификация УПД, ТОРГ-12, Счёт-фактура
- **OCR изображений** — распознавание PNG, JPEG, PDF (без текстового слоя)
- **Извлечение реквизитов** — дата, номер, продавец/покупатель, ИНН, КПП, адреса
- **Парсинг табличных частей** — товары, количество, цена, суммы, НДС
- **Валидация данных** — арифметические проверки, контроль нумерации строк
- **Формирование JSON** — структурированный вывод по JSON Schema
- **Пакетная обработка** — обработка всех файлов в папке
- **CLI и GUI** — командная строка и графический интерфейс (PyQt5)

## Установка

### 1. Клонирование репозитория

```bash
git clone <repository-url>
cd RAG_PP
```

### 2. Создание виртуального окружения

```bash
python -m venv venv
source venv/bin/activate  # Linux/macOS
# или
venv\Scripts\activate     # Windows
```

### 3. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 4. Установка Ollama (опционально, для LLM-извлечения)

LLM-извлечение отключено по умолчанию. Если хотите использовать LLM для улучшения качества на сложных документах:

```bash
# Linux
curl -fsSL https://ollama.com/install.sh | sh

# Рекомендуемые модели (7b+ для качественного JSON-вывода):
ollama pull qwen2.5:7b-instruct    # Рекомендуется
ollama pull llama3.1:8b            # Альтернатива

# Windows — скачайте установщик с https://ollama.com
```

> **Важно**: Маленькие модели (3b и меньше) плохо следуют JSON-формату. Рекомендуется использовать модели 7b+.

### 5. Веса YOLO (опционально)

Поместите веса DocLayNet в папку `weights/`:
```
weights/yolov8x-doclaynet-epoch64-imgsz640-initiallr1e-4-finallr1e-5.pt
```

## Использование

### Командная строка (CLI)

```bash
# Обработка одного файла (без LLM — по умолчанию)
python cli.py --input doc.png --output result.json

# Пакетная обработка папки
python cli.py --input ./documents/ --batch

# С LLM-извлечением (требуется Ollama + модель 7b+)
python cli.py --input doc.pdf --llm --model qwen2.5:7b-instruct

# Подробный вывод
python cli.py --input doc.png -v
```

### Параметры CLI

| Параметр | Описание |
|----------|----------|
| `--input`, `-i` | Путь к файлу или папке (обязательный) |
| `--output`, `-o` | Путь для сохранения JSON |
| `--batch` | Пакетная обработка папки |
| `--llm` | Включить LLM-извлечение (рекомендуется модель 7b+) |
| `--model` | Модель Ollama (по умолчанию: qwen2.5:7b-instruct) |
| `--yolo-conf` | Порог уверенности YOLO (по умолчанию: 0.10) |
| `-v`, `--verbose` | Подробный вывод |

### Веб-интерфейс (GUI)

```bash
python app.py
# Откроется в браузере: http://127.0.0.1:7860
```

## Структура проекта

```
RAG_PP/
├── cli.py                 # CLI интерфейс
├── app.py                 # Веб-интерфейс (Gradio)
├── core/                  # Ядро системы
│   ├── pipeline.py        # Основной пайплайн обработки
│   ├── extractor.py       # Извлечение данных через LLM
│   ├── schemas.py         # Pydantic схемы данных
│   ├── table_parser.py    # Парсинг табличных частей
│   ├── table_html_to_grid.py
│   ├── export_raw_json.py
│   ├── yolo_layout.py     # Детекция layout (YOLO)
│   └── yolo_tables.py     # Детекция таблиц (YOLO)
├── schema/
│   └── structured_document.schema.json
├── weights/               # Веса YOLO
├── data/                  # Тестовые документы
└── output/                # Результаты обработки
```

## Формат выходных данных

Результат сохраняется в JSON согласно схеме `schema/structured_document.schema.json`:

```json
{
  "fields": {
    "doc_type": "ТОРГ-12",
    "doc_number": "11111",
    "doc_date": "31.10.2025",
    "seller": {
      "name": "ООО \"Автотрейд\"",
      "inn": "7799555720",
      "kpp": null,
      "address": null
    },
    "buyer": {
      "name": "ООО \"Эталон\"",
      "inn": "5612034679",
      "kpp": null,
      "address": null
    },
    "total_amount": 100000.0,
    "total_nds": null,
    "total_with_nds": null,
    "items": [
      {
        "row_num": 1,
        "name": "Бензин Аи-92",
        "unit_name": "л",
        "quantity": 1000,
        "price": 100.0,
        "amount": 100000.0,
        "nds_rate": "20%",
        "nds_amount": 20000.0
      }
    ]
  },
  "confidence": 0.8,
  "warnings": [],
  "errors": []
}
```

## Извлекаемые поля

### Реквизиты документа (шапка)

| Поле | Описание |
|------|----------|
| `doc_type` | Тип документа (УПД, ТОРГ-12, Счёт-фактура) |
| `doc_number` | Номер документа |
| `doc_date` | Дата документа (ДД.ММ.ГГГГ) |
| `sf_number` | Номер счёт-фактуры |
| `sf_date` | Дата счёт-фактуры |
| `seller` | Продавец (name, inn, kpp, address) |
| `buyer` | Покупатель (name, inn, kpp, address) |
| `consignor` | Грузоотправитель |
| `consignee` | Грузополучатель |
| `contract_number` | Номер договора |
| `contract_date` | Дата договора |
| `currency` | Валюта (руб., USD, EUR) |

### Табличные части (позиции)

| Поле | Описание |
|------|----------|
| `row_num` | Номер строки (п/п) |
| `name` | Наименование товара/услуги |
| `unit_code` | Код единицы измерения (ОКЕИ) |
| `unit_name` | Наименование единицы |
| `quantity` | Количество |
| `price` | Цена за единицу |
| `amount` | Сумма без НДС |
| `nds_rate` | Ставка НДС (20%, 10%, 0%) |
| `nds_amount` | Сумма НДС |
| `total_amount` | Сумма с НДС |

## Валидация

Система выполняет следующие проверки:

### Арифметические проверки
- Количество × Цена = Сумма (для каждой строки)
- Сумма позиций = Итого документа
- Проверка расчёта НДС по ставке

### Проверка нумерации строк
- Последовательность номеров (1, 2, 3...)
- Отсутствие пропусков
- Отсутствие дубликатов

### Проверка реквизитов
- Формат ИНН (10 цифр для юрлиц, 12 для ИП)
- Наличие обязательных полей

## Пайплайн обработки

```
Входной файл (PNG/JPG/PDF)
         │
         ▼
┌─────────────────────┐
│   Загрузка файла    │
│   + padding         │
└─────────────────────┘
         │
         ▼
┌─────────────────────┐
│    PaddleOCR        │──► Распознавание текста (русский)
└─────────────────────┘
         │
         ▼
┌─────────────────────┐
│   YOLO Layout       │──► Детекция блоков документа
└─────────────────────┘
         │
         ▼
┌─────────────────────┐
│   YOLO Tables       │──► Детекция таблиц
└─────────────────────┘
         │
         ▼
┌─────────────────────┐
│   TSR (SLANet)      │──► Структура таблиц
└─────────────────────┘
         │
         ▼
┌─────────────────────┐
│   LLM Extractor     │──► Извлечение реквизитов
│   (Ollama)          │
└─────────────────────┘
         │
         ▼
┌─────────────────────┐
│   Table Parser      │──► Парсинг позиций
└─────────────────────┘
         │
         ▼
┌─────────────────────┐
│   Валидация         │──► Проверки
└─────────────────────┘
         │
         ▼
     result.json
```

## Технологии

| Компонент | Технология |
|-----------|------------|
| OCR | PaddleOCR (русский язык) |
| Layout Detection | YOLOv8 (DocLayNet) |
| Table Structure | PaddleOCR TSR (SLANet) |
| LLM | Ollama (Qwen2.5) — опционально |
| GUI | Gradio (веб-интерфейс) |
| Схемы данных | Pydantic |
| PDF | PyMuPDF |

## Системные требования

| Параметр | Требование |
|----------|------------|
| ОС | Windows 10/11 x64 или Linux (Astra Linux, Ubuntu, Debian) |
| RAM | минимум 8 ГБ (рекомендуется 16 ГБ) |
| CPU | Intel Core i5 12-го поколения или аналог |
| Диск | SSD, минимум 10 ГБ свободного места |

## Программное использование

```python
from core.pipeline import DocumentPipeline, PipelineConfig

config = PipelineConfig(
    yolo_weights="weights/yolov8x-doclaynet-epoch64-imgsz640-initiallr1e-4-finallr1e-5.pt",
    output_dir="output",
    ollama_model="qwen2.5:7b-instruct"  # Только если используете LLM
)

pipeline = DocumentPipeline(config)

# Без LLM (по умолчанию) — быстро и надёжно
results = pipeline.process_file("document.png", extract_fields=False)

# С LLM — для сложных документов (требуется Ollama)
# results = pipeline.process_file("document.png", extract_fields=True)

for doc in results:
    print(f"Тип: {doc.fields.doc_type}")
    print(f"Номер: {doc.fields.doc_number}")
    print(f"Дата: {doc.fields.doc_date}")
    print(f"Продавец: {doc.fields.seller.name}")
    print(f"Итого: {doc.fields.total_with_nds}")
```

## Известные ограничения

- LLM-извлечение требует запущенного Ollama и модели 7b+ для надёжной работы
- Маленькие модели (3b и меньше) плохо следуют JSON-формату
- Качество распознавания зависит от качества скана
- Нестандартные формы документов могут распознаваться хуже

## Лицензия

Проект разработан в рамках проектного обучения УрФУ.
